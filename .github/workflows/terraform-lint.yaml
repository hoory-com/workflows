name: Terraform Lint

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    secrets:
      GITHUB_PAT:
        required: true

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - uses: hashicorp/setup-terraform@v2

      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -backend=false >/dev/null

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

  put-comment:
    needs: [lint]
    uses: hoory-com/workflows/.github/workflows/pr-comment.yaml@master
    if: github.event.pull_request.merged == true && inputs.USE_SURGE == true
    with:
      COMMENT_TEXT: |
        |
          #### \`${{ jobs.lint.steps.fmt.outcome }}\` Terraform Format and Style 🖌
          #### \`${{ jobs.lint.steps.init.outcome }}\` Terraform Initialization ⚙️
          #### \`${{ jobs.lint.steps.validate.outcome }}\` Terraform Validation 🤖
          <details><summary>Validation Output</summary>
      
          \`\`\`\n
          ${{ steps.validate.outputs.stdout }}
          \`\`\`
      
          </details>
      
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*


